# Thyroid Echo Report v1.6.x 開發記錄

## 版本總覽

| 版本 | 日期 | 主要變更 |
|------|------|----------|
| v1.6.0 | 2025-01-11 | 新增甲狀腺疾病診斷識別 |
| v1.6.1 | 2025-01-11 | 擴充疾病診斷字典（12 種常見疾病） |
| v1.6.2 | 2025-01-11 | 修正換行符號處理、引號字元統一、葉模式診斷解析 |
| v1.6.3 | 2025-01-11 | 移除重複診斷顯示，診斷只保留在 Impression 中 |

---

## v1.6.0 - 新增甲狀腺疾病診斷識別

### 需求
用戶希望在口述中加入「自體免疫性的甲狀腺疾病」等診斷，並在報告 Impression 中顯示。

### 實作內容

#### 1. 新增疾病診斷字典 (`MedicalDictionary.gs`)
```javascript
const THYROID_DIAGNOSIS_TERMS = {
  '自體免疫性甲狀腺疾病': 'Autoimmune thyroid disease',
  '自體免疫性的甲狀腺疾病': 'Autoimmune thyroid disease',
  '自體免疫甲狀腺炎': 'Autoimmune thyroiditis',
  'autoimmune thyroid disease': 'Autoimmune thyroid disease',
  // ...
};
```

#### 2. 新增解析函數 (`MedicalDictionary.gs`)
```javascript
function parseThyroidDiagnoses(input) {
  const diagnoses = [];
  const normalizedInput = input.toLowerCase();

  for (const [term, diagnosis] of Object.entries(THYROID_DIAGNOSIS_TERMS)) {
    if (normalizedInput.includes(term.toLowerCase())) {
      if (!diagnoses.includes(diagnosis)) {
        diagnoses.push(diagnosis);
      }
    }
  }
  return diagnoses;
}
```

#### 3. 更新 Impression 生成 (`Code.gs`)
在 `generateMixedImpression()` 中加入診斷顯示。

---

## v1.6.1 - 擴充疾病診斷字典

### 需求
用戶提供 12 種常見甲狀腺疾病清單，需要全部支援。

### 新增疾病列表

| 疾病 | 英文名稱 |
|------|----------|
| 橋本氏甲狀腺炎 | Hashimoto's thyroiditis |
| 葛瑞夫氏病 | Graves' disease |
| 亞急性甲狀腺炎 | Subacute (de Quervain) thyroiditis |
| 無痛性甲狀腺炎 | Painless (silent) thyroiditis |
| 產後甲狀腺炎 | Postpartum thyroiditis |
| 急性化膿性甲狀腺炎 | Acute suppurative thyroiditis |
| 多結節性甲狀腺腫 | Multinodular goiter |
| 瀰漫性甲狀腺腫 | Diffuse goiter |
| 原發性甲狀腺淋巴瘤 | Primary thyroid lymphoma |
| Riedel 甲狀腺炎 | Riedel's thyroiditis |
| 甲狀腺膿瘍 | Thyroid abscess |
| 藥物性甲狀腺炎 | Drug-induced thyroiditis |

### 實作
每種疾病都包含：
- 中文正式名稱
- 中文口語變體
- 英文名稱
- 英文縮寫/變體

---

## v1.6.2 - Bug 修正

### 問題描述
用戶輸入：
```
右葉大小：2 × 1 × 3 cm，Homogeneous，血流過多
左葉大小：1 × 2 × 3 cm，Hyperechoic，血流正常
Graves' disease
```

**預期結果**：顯示右葉、左葉、Graves' disease 診斷
**實際結果**：只顯示右葉，左葉和診斷都沒出現

### 根本原因分析

#### 問題 1：換行符被移除
`normalizeInput()` 使用 `\s+` 取代所有空白字元，包括換行符：
```javascript
// 錯誤寫法
result = result.replace(/\s+/g, ' ');
```
這導致多行輸入變成單行，`parseLobeInput()` 無法正確分割。

**修正**：
```javascript
// 只取代水平空白，保留換行符
result = result.replace(/[^\S\r\n]+/g, ' ');
```

#### 問題 2：引號字元不匹配
用戶輸入使用「彎引號」`'`（U+2019），但字典使用「直引號」`'`（U+0027）：
- 輸入：`Graves' disease`（彎引號）
- 字典：`"graves' disease": "Graves' disease"`（直引號）

**修正**：新增 `normalizeApostrophe()` 函數統一引號字元：
```javascript
function normalizeApostrophe(text) {
  return text
    .replace(/[\u2018\u2019\u201B\u0060\u00B4]/g, "'")  // ' ' ‛ ` ´ → '
    .replace(/[\u201C\u201D\u201E\u201F]/g, '"');       // " " „ ‟ → "
}
```

#### 問題 3：葉模式未解析診斷
當輸入只有葉描述（無結節）時，走 `processLobeMode()`，但該函數未呼叫 `parseThyroidDiagnoses()`。

**修正**：在 `processLobeMode()` 中加入診斷解析：
```javascript
function processLobeMode(input) {
  const lobes = parseLobeInput(input);
  // ...

  // 解析甲狀腺疾病診斷
  const diagnoses = parseThyroidDiagnoses(input);
  if (diagnoses.length > 0) {
    result.diagnoses = diagnoses;
  }

  result.impression = generateLobeImpressionWithDiagnosis(lobes, diagnoses);
  return result;
}
```

新增 `generateLobeImpressionWithDiagnosis()` 函數：
```javascript
function generateLobeImpressionWithDiagnosis(lobes, diagnoses) {
  const lines = [];
  let itemNum = 1;

  if (lobes.rightLobe) {
    lines.push(`${itemNum}) ${formatLobeImpression(lobes.rightLobe, 'Right lobe')}`);
    itemNum++;
  }
  if (lobes.leftLobe) {
    lines.push(`${itemNum}) ${formatLobeImpression(lobes.leftLobe, 'Left lobe')}`);
    itemNum++;
  }
  if (lobes.isthmus) {
    lines.push(`${itemNum}) ${formatIsthmusImpression(lobes.isthmus)}`);
    itemNum++;
  }
  if (diagnoses && diagnoses.length > 0) {
    lines.push(`${itemNum}) Diagnosis: ${diagnoses.join('; ')}.`);
  }

  return lines.join('\n') || 'No lobe information';
}
```

---

## v1.6.3 - 移除重複診斷顯示

### 問題描述
診斷資訊在兩個地方顯示：
1. 獨立的 `=== Diagnosis ===` 區塊
2. Impression 底部

用戶反映重複，希望只在 Impression 保留。

### 修正內容 (`WebApp.html`)

#### 移除 HTML 顯示中的診斷卡片
```javascript
// 刪除此區塊
if (result.diagnoses && result.diagnoses.length > 0) {
  html += `<div class="diagnosis-card" style="...">
    <strong>Diagnosis:</strong> ${result.diagnoses.join('; ')}
  </div>`;
}
```

#### 移除複製文字中的診斷區塊
```javascript
// 刪除此區塊
if (result.diagnoses && result.diagnoses.length > 0) {
  text += `=== Diagnosis ===\n${result.diagnoses.join('; ')}\n\n`;
}
```

---

## 最終輸出範例

### 輸入
```
右葉大小：2 × 1 × 3 cm，Homogeneous，血流過多
左葉大小：1 × 2 × 3 cm，Hyperechoic，血流正常
Graves' disease
```

### 輸出

#### 畫面顯示
```
=== Thyroid Lobes ===
Right Lobe: 2 x 1 x 3 cm (vol 3.14 mL); echotexture: Homogeneous; vascularity: Increased
Left Lobe: 1 x 2 x 3 cm (vol 3.14 mL); echogenicity: Hyperechoic; vascularity: Normal

Impression:
1) Right lobe: 3.14 mL, Homogeneous, Increased vascularity.
2) Left lobe: 3.14 mL, Hyperechoic, Normal vascularity.
3) Diagnosis: Graves' disease.
```

#### 複製文字
```
=== Thyroid Lobes ===
Right lobe: 2 x 1 x 3 cm (vol 3.14 mL); echotexture: Homogeneous; vascularity: Increased
Left lobe: 1 x 2 x 3 cm (vol 3.14 mL); echogenicity: Hyperechoic; vascularity: Normal

Impression:
1) Right lobe: 3.14 mL, Homogeneous, Increased vascularity.
2) Left lobe: 3.14 mL, Hyperechoic, Normal vascularity.
3) Diagnosis: Graves' disease.
```

---

## 檔案變更總覽

### `gas/MedicalDictionary.gs`
- 新增 `THYROID_DIAGNOSIS_TERMS` 字典（12 種疾病，含中英文變體）
- 新增 `normalizeApostrophe()` 函數
- 新增 `parseThyroidDiagnoses()` 函數
- 新增 `hasDiagnosis()` 函數
- 修正 `normalizeInput()` 保留換行符

### `gas/Code.gs`
- 更新 `processLobeMode()` 加入診斷解析
- 新增 `generateLobeImpressionWithDiagnosis()` 函數
- 更新 `generateMixedImpression()` 加入診斷顯示
- 更新版本號至 1.6.3

### `gas/WebApp.html`
- 移除獨立診斷卡片顯示
- 移除複製文字中的 `=== Diagnosis ===` 區塊
- 更新版本號至 1.6.3

---

## 部署資訊

- **GitHub**: https://github.com/zinojeng/thyroid_echo
- **GAS Web App**: https://script.google.com/macros/s/AKfycbxn6Poedtnx7vlQ_iSQovGTiV2V6KKQY3_ujniC1uFVhrOul93qOZJtjC_iMbm32u_F/exec
- **Commit**: `ddde8cd` - refactor: 移除重複診斷顯示，診斷只保留在 Impression (v1.6.3)
